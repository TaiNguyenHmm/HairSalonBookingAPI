@page
@{
    ViewData["Title"] = "Đánh Giá Của Tôi";
    Layout = "/Pages/Shared/_StylistDashboardLayout.cshtml";
}

<!-- Reviews Table -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full table-auto">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Khách hàng</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Xếp hạng</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Bình luận</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Lịch hẹn (Dịch vụ/Stylist)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Trạng thái</th>
                </tr>
            </thead>
            <tbody id="review-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                <tr>
                    <td colspan="5" class="text-center p-4 text-gray-500">Đang tải dữ liệu...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const reviewTableBody = document.getElementById('review-table-body');
            if (!reviewTableBody) return; // tránh lỗi nếu tbody không tồn tại

            const ratingFilter = document.getElementById('rating-filter'); // nếu có filter
            const statusFilter = document.getElementById('status-filter');   // nếu có filter
            const filterForm = document.getElementById('review-filter-form'); // optional

            const reviewsApiUrl = "https://localhost:7144/api/ReviewsModeration";
            const token = localStorage.getItem("jwtToken");

            const stylistId = parseInt(localStorage.getItem("stylistId"));
            if (!stylistId) {
                alert("Không tìm thấy stylistId. Vui lòng đăng nhập lại.");
                return;
            }

            async function loadReviews() {
                reviewTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Đang tải dữ liệu...</td></tr>';

                try {
                    const res = await fetch(`${reviewsApiUrl}?stylistId=${stylistId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error('Không thể tải dữ liệu');

                    let data = await res.json();

                    if (ratingFilter?.value) data = data.filter(r => r.rating === parseInt(ratingFilter.value));
                    if (statusFilter?.value && statusFilter.value === 'Hidden') data = data.filter(r => r.isHidden);

                    if (!data || data.length === 0) {
                        reviewTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Không có dữ liệu.</td></tr>';
                        return;
                    }

                    reviewTableBody.innerHTML = data.map(r => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${r.customerName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                                ${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900 dark:text-white max-w-sm break-words">${r.comment}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${r.bookingInfo}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                                ${r.isHidden ? 'Đã ẩn' : 'Hiển thị'}
                            </td>
                        </tr>
                    `).join('');
                } catch (err) {
                    console.error(err);
                    reviewTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">Lỗi khi tải dữ liệu!</td></tr>';
                }
            }

            if (filterForm) {
                filterForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    loadReviews();
                });
            }

            loadReviews();
        });
    </script>
}
