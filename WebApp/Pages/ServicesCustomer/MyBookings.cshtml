@page
@{
    ViewData["Title"] = "Lịch hẹn của tôi";
    Layout = "_LayoutCustomer"; // dùng layout chung
}

@section Styles {
    <style>
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #b45309;
        }

        .status-confirmed {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .tab-btn {
            border-bottom-width: 2px;
            border-color: transparent;
        }

            .tab-btn.active {
                border-color: #4f46e5;
                color: #4f46e5;
            }

        /* CSS cho modal đánh giá sao */
        .star-rating .star {
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating:hover .star {
            color: #f59e0b; /* yellow-500 */
        }

        .star-rating .star:hover ~ .star {
            color: #d1d5db; /* gray-300 */
        }

        .star-rating .star.selected,
        .star-rating .star.selected ~ .star {
            color: #f59e0b; /* yellow-500 */
        }

    </style>
}

<div class="py-16 md:py-24">
    <div class="container mx-auto px-6 max-w-5xl">
        <h1 class="text-4xl md:text-5xl font-bold mb-8 text-center text-gray-900 dark:text-white">
            Lịch Hẹn Của Tôi
        </h1>

        <!-- Tabs để lọc -->
        <div class="flex justify-center border-b border-gray-200 dark:border-gray-700 mb-8">
            <button class="tab-btn px-6 py-3 font-semibold active" data-filter="upcoming">Sắp tới</button>
            <button class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-indigo-500" data-filter="past">Đã qua</button>
            <button class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-indigo-500" data-filter="all">Tất cả</button>
        </div>

        <!-- Danh sách lịch hẹn -->
        <div id="bookings-list" class="space-y-6">
            <div id="bookings-loader" class="text-center py-10">
                <p class="text-gray-500 dark:text-gray-400">Đang tải lịch hẹn của bạn...</p>
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto mt-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <div id="bookings-empty" class="text-center py-10 hidden">
                <p class="text-gray-500 dark:text-gray-400 text-lg">Bạn chưa có lịch hẹn nào.</p>
                <a href="/services" class="mt-4 inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    Đặt lịch ngay
                </a>
            </div>
        </div>
    </div>
</div>

<!-- === MODALS === -->
<!-- Modal Hủy lịch (Ẩn ban đầu) -->
<div id="cancel-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full">
        <h3 class="text-2xl font-bold mb-4">Xác nhận Hủy lịch</h3>
        <p class="mb-6 text-gray-600 dark:text-gray-400">Bạn có chắc chắn muốn hủy lịch hẹn này không?</p>
        <div class="flex justify-end space-x-4">
            <button id="close-cancel-modal" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Không</button>
            <button id="confirm-cancel-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Hủy lịch</button>
        </div>
    </div>
</div>

<!-- Modal Đánh giá (Ẩn ban đầu) -->
<div id="review-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full">
        <h3 class="text-2xl font-bold mb-4">Viết Đánh Giá</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">Dịch vụ: <span id="review-service-name" class="font-semibold">Cắt tóc nam</span></p>
        <div class="mb-4">
            <label class="block font-medium mb-2">Xếp hạng của bạn</label>
            <!-- Cập nhật CSS cho sao -->
            <div class="flex flex-row-reverse justify-end space-x-1 space-x-reverse star-rating" id="star-rating">
                <svg data-value="5" class="star w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" /></svg>
                <svg data-value="4" class="star w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" /></svg>
                <svg data-value="3" class="star w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" /></svg>
                <svg data-value="2" class="star w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" /></svg>
                <svg data-value="1" class="star w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" /></svg>
            </div>
            <input type="hidden" id="review-rating" value="0">
        </div>
        <div class="mb-6">
            <label for="review-comment" class="block font-medium mb-2">Bình luận của bạn (Không bắt buộc)</label>
            <textarea id="review-comment" rows="4" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
        </div>
        <div class="flex justify-end space-x-4">
            <button id="close-review-modal" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Đóng</button>
            <button id="submit-review-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Gửi đánh giá</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function getJwtToken() { return localStorage.getItem('jwtToken'); }

        function formatDateTime(isoString) {
            const d = new Date(isoString);
            return d.toLocaleString('vi-VN', {
                dateStyle: 'short',
                timeStyle: 'short',
                hour12: false
            }).replace(',', ' -');
        }

        const bookingsList = document.getElementById('bookings-list');
        const loader = document.getElementById('bookings-loader');
        const emptyState = document.getElementById('bookings-empty');
        const tabButtons = document.querySelectorAll('.tab-btn');
        let allBookingsCache = [];

        // --- Modal elements ---
        const cancelModal = document.getElementById('cancel-modal');
        const reviewModal = document.getElementById('review-modal');
        let currentBookingIdToCancel = null;
        let currentBookingIdToReview = null;
        const reviewModalCloseBtn = document.getElementById('close-review-modal');
        const reviewModalSubmitBtn = document.getElementById('submit-review-btn');
        const stars = document.querySelectorAll('#star-rating .star');
        const ratingInput = document.getElementById('review-rating');
        const commentInput = document.getElementById('review-comment');
        // --- Hết Modal elements ---

        async function fetchBookings() {
            loader.classList.remove('hidden');
            emptyState.classList.add('hidden');
            bookingsList.innerHTML = '';
            bookingsList.appendChild(loader);

            const token = getJwtToken();
            if (!token) {
                loader.classList.add('hidden');
                bookingsList.innerHTML = '<p class="text-red-500 text-center">Bạn cần đăng nhập để xem lịch hẹn.</p>';
                return;
            }

            try {
                const apiUrl = "https://localhost:7144/api/Booking/MyBookings";
                const res = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error(res.status === 401 ? 'Phiên đăng nhập hết hạn' : 'Lỗi tải lịch hẹn');
                allBookingsCache = await res.json();
                renderBookings('upcoming');
            } catch (err) {
                console.error(err);
                loader.classList.add('hidden');
                bookingsList.innerHTML = `<p class="text-red-500 text-center">${err.message}</p>`;
            }
        }

        function renderBookings(filter = 'upcoming') {
            loader.classList.add('hidden');
            bookingsList.innerHTML = '';
            const now = new Date();
            let filtered = [];

            if (filter === 'upcoming') {
                filtered = allBookingsCache.filter(b => new Date(b.startTime) >= now && !['Completed','Cancelled'].includes(b.status));
            } else if (filter === 'past') {
                filtered = allBookingsCache.filter(b => new Date(b.startTime) < now || ['Completed','Cancelled'].includes(b.status));
            } else {
                filtered = allBookingsCache;
            }

            emptyState.classList.add('hidden');
            if (!filtered.length) {
                emptyState.classList.remove('hidden');
                if (filter === 'upcoming') emptyState.querySelector('p').textContent = 'Bạn không có lịch hẹn nào sắp tới.';
                else if (filter === 'past') emptyState.querySelector('p').textContent = 'Bạn không có lịch hẹn nào đã qua.';
                else emptyState.querySelector('p').textContent = 'Bạn chưa có lịch hẹn nào.';
                return;
            }

            filtered.sort((a,b)=> new Date(b.startTime)-new Date(a.startTime));
            filtered.forEach(b => bookingsList.appendChild(createBookingCard(b)));
        }

        function createBookingCard(b) {
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 flex flex-col md:flex-row justify-between';

            let status = '';
            switch(b.status) {
                case 'Pending': status='<span class="status-badge status-pending">Chờ xác nhận</span>'; break;
                case 'Confirmed': status='<span class="status-badge status-confirmed">Đã xác nhận</span>'; break;
                case 'Completed': status='<span class="status-badge status-completed">Hoàn thành</span>'; break;
                case 'Cancelled': status='<span class="status-badge status-cancelled">Đã hủy</span>'; break;
            }

            let actions = '';
            if (b.status === 'Pending' || b.status === 'Confirmed') {
                actions += `<button class="btn-cancel w-full md:w-auto text-red-600 hover:text-red-800 font-semibold transition" data-booking-id="${b.id}">Hủy lịch</button>`;
            }
            if (b.status === 'Completed' && !b.isReviewed) {
                actions += `<button class="btn-review w-full md:w-auto text-indigo-600 hover:text-indigo-800 font-semibold transition" data-booking-id="${b.id}" data-service-name="${b.serviceName}">Đánh giá</button>`;
            }
            if (b.status === 'Completed' && b.isReviewed) {
                actions += `<span class="text-sm text-gray-400 italic">Đã đánh giá</span>`;
            }
            if (actions === '') actions = '<p class="text-sm text-gray-400">Không có hành động</p>';

            card.innerHTML = `
                <div class="flex-grow mb-4 md:mb-0">
                    <div class="flex items-center mb-2">${status}</div>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">${b.serviceName}</h3>
                    <p class="text-gray-600 dark:text-gray-400">Với Stylist: ${b.stylistName}</p>
                    <p class="text-gray-600 dark:text-gray-400 font-semibold mt-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 -mt-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        ${formatDateTime(b.startTime)}
                    </p>
                </div>
                <div class="flex-shrink-0 flex flex-col items-start md:items-end justify-center space-y-2">
                    ${actions}
                </div>
            `;
            return card;
        }

        // Tab switching
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderBookings(btn.dataset.filter);
            });
        });

        // --- Modal logic ---
        bookingsList.addEventListener('click', function(e) {
            const target = e.target;
            if (target.classList.contains('btn-cancel')) {
                currentBookingIdToCancel = target.dataset.bookingId;
                cancelModal.classList.remove('hidden');
            }
            if (target.classList.contains('btn-review')) {
                currentBookingIdToReview = target.dataset.bookingId;
                document.getElementById('review-service-name').textContent = target.dataset.serviceName;
                resetReviewModal();
                reviewModal.classList.remove('hidden');
            }
        });

        // Cancel modal
        document.getElementById('confirm-cancel-btn').addEventListener('click', async () => {
            const token = getJwtToken();
            const apiUrl = `https://localhost:7144/api/Booking/${currentBookingIdToCancel}/cancel`;
            try {
                const res = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err?.message || 'Hủy lịch thất bại');
                }
                alert('Đã hủy lịch thành công.');
                cancelModal.classList.add('hidden');
                fetchBookings();
            } catch (err) {
                alert(err.message);
            }
        });
        document.getElementById('close-cancel-modal').addEventListener('click', () => cancelModal.classList.add('hidden'));

        // Review modal
        reviewModalCloseBtn.addEventListener('click', () => reviewModal.classList.add('hidden'));

        // Chọn sao
        stars.forEach(star => {
            star.addEventListener('click', () => {
                const rating = star.dataset.value;
                ratingInput.value = rating;
                stars.forEach(s => s.classList.toggle('selected', s.dataset.value <= rating));
            });
        });

        // Reset review modal
        function resetReviewModal() {
            ratingInput.value = 0;
            commentInput.value = '';
            stars.forEach(s => s.classList.remove('selected'));
        }

        // Submit review
                 reviewModalSubmitBtn.addEventListener('click', async () => {
            const rating = ratingInput.value;
            const comment = commentInput.value;
            if (rating == 0) {
                alert('Vui lòng chọn số sao đánh giá.');
                return;
            }

            const token = getJwtToken();
            const apiUrl = 'https://localhost:7144/api/Booking/Review';
            try {
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bookingId: parseInt(currentBookingIdToReview),
                        rating: parseInt(rating),
                        comment
                    })
                });

                if (!res.ok) throw new Error('Gửi đánh giá thất bại');

                alert('Cảm ơn bạn đã đánh giá!');
                reviewModal.classList.add('hidden');
                location.reload(); // reload toàn bộ trang
            } catch (err) {
                alert(err.message);
            }
        });



        document.addEventListener('DOMContentLoaded', fetchBookings);
    </script>
}


