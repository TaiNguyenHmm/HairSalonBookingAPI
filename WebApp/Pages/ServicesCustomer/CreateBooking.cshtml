@page
@{
    Layout = "_LayoutCustomer";
    ViewData["Title"] = "Hoàn Tất Đặt Lịch";
}

@section Styles {
    <style>
        .step {
            transition: all 0.3s ease-in-out;
        }

        .step-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .step-active .step-content {
            max-height: 1000px;
        }

        .stylist-card.selected {
            border-color: #4f46e5;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
        }

        .timeslot.selected {
            background-color: #4f46e5;
            color: white;
        }

        .stylist-card.selected {
            border-color: #6366f1; /* indigo-500 */
            background-color: #eef2ff; /* indigo-50 */
        }

    </style>
}

<section class="py-16 md:py-24">
    <div class="container mx-auto px-6 max-w-4xl">
        <h1 class="text-4xl md:text-5xl font-bold mb-8 text-center text-gray-900 dark:text-white">Hoàn Tất Đặt Lịch</h1>

        <div class="space-y-8">
            <!-- Step 1: Dịch vụ -->
            <div id="step-service" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">1. Dịch Vụ Của Bạn</h2>
                <div id="service-summary" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 flex justify-between items-center">
                    <div class="animate-pulse w-full">
                        <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/3"></div>
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Stylist -->
            <div id="step-stylist" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 opacity-50">
                <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">2. Chọn Stylist</h2>
                <div id="stylist-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p class="text-gray-500 dark:text-gray-400">Vui lòng chọn dịch vụ trước...</p>
                </div>
            </div>

            <!-- Step 3: Ngày & Giờ -->
            <div id="step-time" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 opacity-50">
                <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">3. Chọn Ngày & Giờ</h2>
                <div id="time-picker-content" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <label for="booking-date" class="block text-sm font-medium mb-2">Chọn ngày</label>
                        <input type="date" id="booking-date" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <p class="text-sm font-medium mb-2">Chọn giờ (còn trống)</p>
                        <div id="timeslot-list" class="grid grid-cols-3 gap-2">
                            <p class="text-gray-500 dark:text-gray-400 col-span-3">Vui lòng chọn ngày...</p>
                        </div>
                    </div>
                </div>
                <p id="time-picker-placeholder" class="text-gray-500 dark:text-gray-400">Vui lòng chọn stylist trước...</p>
            </div>

            <!-- Step 4: Xác nhận -->
            <div id="step-confirm" class="text-center opacity-50">
                <button id="confirm-booking-btn" class="w-full max-w-md mx-auto bg-indigo-600 text-white px-8 py-4 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 text-lg shadow-lg" disabled>
                    Xác nhận Đặt lịch
                </button>
                <p id="confirmation-error" class="text-red-500 mt-4"></p>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // ==========================
        // Helpers
        // ==========================
        function getJwtToken() {
            // ưu tiên localStorage
            let token = localStorage.getItem('jwtToken');
            if (token) return token;

            // nếu không có, thử lấy từ cookie
            const match = document.cookie.match(/(?:^|;\s*)jwt=([^;]+)/);
            return match ? match[1] : null;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
        }

        // ==========================
        // Booking state
        // ==========================
        const bookingSelection = {
            serviceId: null,
            serviceName: '',
            serviceDuration: 0,
            servicePrice: 0,
            stylistId: null,
            stylistName: '',
            startTime: null
        };

        const stepStylist = document.getElementById('step-stylist');
        const stepTime = document.getElementById('step-time');
        const stepConfirm = document.getElementById('step-confirm');
        const confirmBookingBtn = document.getElementById('confirm-booking-btn');

        const stylistApiUrl = 'https://localhost:7144/api/Stylist';
        const bookingApiUrl = 'https://localhost:7144/api/Booking';
        const serviceApiUrl = 'https://localhost:7144/api/Service';

        // ==========================
        // Step 1: Load service
        // ==========================
        async function loadServiceDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const serviceId = parseInt(urlParams.get('serviceId'));
            if (!serviceId) {
                document.getElementById('service-summary').innerHTML =
                    '<p class="text-red-500">Không tìm thấy dịch vụ.</p>';
                return;
            }

            try {
                const token = getJwtToken();
                console.log("[DEBUG] JWT token khi load service:", token);

                const res = await fetch(serviceApiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Không thể tải dịch vụ.');

                const services = await res.json();
                const service = services.find(s => s.id === serviceId);
                if (!service) throw new Error('Dịch vụ không tồn tại.');

                bookingSelection.serviceId = service.id;
                bookingSelection.serviceName = service.name;
                bookingSelection.serviceDuration = typeof service.duration === 'string'
                    ? parseInt(service.duration.split(':')[0]) * 60 + parseInt(service.duration.split(':')[1])
                    : service.duration || 30;
                bookingSelection.servicePrice = service.price;

                document.getElementById('service-summary').innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${escapeHtml(service.name)}</h3>
                        <p class="text-gray-600 dark:text-gray-400">${escapeHtml(service.description)}</p>
                    </div>
                    <span class="text-xl font-bold text-gray-800 dark:text-white">${formatCurrency(service.price)}</span>
                `;

                activateStep(stepStylist);
                await loadStylists();
            } catch (err) {
                document.getElementById('service-summary').innerHTML =
                    `<p class="text-red-500">${escapeHtml(err.message)}</p>`;
            }
        }

        // ==========================
        // Step 2: Load stylists
        // ==========================
        async function loadStylists() {
            const stylistList = document.getElementById('stylist-list');
            stylistList.innerHTML = '<p class="text-gray-500">Đang tải stylist...</p>';

            try {
                const token = getJwtToken();
                console.log("[DEBUG] JWT token khi load stylist:", token);

                const res = await fetch(stylistApiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const stylists = await res.json();
                stylistList.innerHTML = '';
                stylists.forEach(sRaw => {
                    const s = {
                        id: sRaw.id ?? sRaw.Id,
                        fullName: sRaw.fullName ?? sRaw.FullName ?? 'Không tên',
                        bio: sRaw.bio ?? sRaw.Bio ?? '',
                        avatar: sRaw.avatarUrl ?? sRaw.avatar ?? null
                    };
                    if (!s.id) return;

                    const card = document.createElement('div');
                    card.className = 'stylist-card border-2 border-gray-200 dark:border-gray-700 rounded-lg p-4 flex items-center space-x-4 cursor-pointer hover:border-indigo-500 transition relative';
                    card.dataset.id = s.id;
                    card.dataset.name = s.fullName;

                    const initial = s.fullName.charAt(0).toUpperCase();
                    const imgSrc = s.avatar || `https://placehold.co/64x64/e0e7ff/4f46e5?text=${encodeURIComponent(initial)}`;
                    card.innerHTML = `
                        <img src="${imgSrc}" alt="${escapeHtml(s.fullName)}" class="w-16 h-16 rounded-full object-cover">
                        <div>
                            <h4 class="text-lg font-bold">${escapeHtml(s.fullName)}</h4>
                            <p class="text-sm text-gray-500">${escapeHtml(s.bio)}</p>
                        </div>
                    `;
                    card.addEventListener('click', () => selectStylist(card));
                    stylistList.appendChild(card);
                });
            } catch (err) {
                console.error('loadStylists error:', err);
                stylistList.innerHTML = `<p class="text-red-500">Không thể tải danh sách stylist. ${escapeHtml(err.message)}</p>`;
            }
        }

        function selectStylist(card) {
            document.querySelectorAll('.stylist-card').forEach(c => {
                c.classList.remove('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/30');
                const check = c.querySelector('.checkmark');
                if (check) check.remove();
            });

            card.classList.add('border-indigo-500', 'bg-indigo-50', 'dark:bg-indigo-900/30');

            const checkIcon = document.createElement('div');
            checkIcon.className = 'checkmark absolute top-2 right-2 text-indigo-600';
            checkIcon.innerHTML = '✅';
            card.appendChild(checkIcon);

            bookingSelection.stylistId = parseInt(card.dataset.id);
            bookingSelection.stylistName = card.dataset.name;

            console.log("Stylist đã chọn:", bookingSelection.stylistName);

            activateStep(stepTime);
            document.getElementById('time-picker-placeholder').classList.add('hidden');
            document.getElementById('time-picker-content').classList.remove('hidden');
        }

        // ==========================
        // Step 3: Chọn thời gian
        // ==========================
        function selectTimeSlot(btn, date) {
            document.querySelectorAll('.timeslot').forEach(s => s.classList.remove('selected'));
            btn.classList.add('selected');
            bookingSelection.startTime = new Date(`${date}T${btn.dataset.time}`);
            console.log("Giờ đã chọn:", bookingSelection.startTime);
            confirmBookingBtn.disabled = false;
            activateStep(stepConfirm);
        }

        document.getElementById('booking-date').addEventListener('change', async function() {
            const date = this.value;
            const stylistId = bookingSelection.stylistId;
            if (!date || !stylistId) return;

            const list = document.getElementById('timeslot-list');
            list.innerHTML = '<p class="col-span-3 text-gray-500">Đang tải...</p>';

            try {
                const token = getJwtToken();
                console.log("[DEBUG] JWT token khi load times:", token);

                const res = await fetch(`${bookingApiUrl}/${stylistId}/available-times?date=${date}&serviceId=${bookingSelection.serviceId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Không thể tải khung giờ.');

                const slots = await res.json();
                list.innerHTML = '';
                if (slots.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 col-span-3">Không còn giờ trống hôm nay.</p>';
                    return;
                }

                slots.forEach(time => {
                    const btn = document.createElement('button');
                    btn.className = 'timeslot p-2 border rounded-md text-sm hover:border-indigo-500 transition';
                    btn.textContent = time;
                    btn.dataset.time = time;
                    btn.addEventListener('click', () => selectTimeSlot(btn, date));
                    list.appendChild(btn);
                });

            } catch (err) {
                console.error('Error loading times:', err);
                list.innerHTML = '<p class="text-red-500 col-span-3">Lỗi tải khung giờ.</p>';
            }
        });

        // ==========================
        // Step 4: Xác nhận booking
        // ==========================
        confirmBookingBtn.addEventListener('click', async function() {
            const err = document.getElementById('confirmation-error');
            err.textContent = '';

            if (!bookingSelection.serviceId || !bookingSelection.stylistId || !bookingSelection.startTime) {
                err.textContent = 'Vui lòng hoàn tất tất cả các bước.';
                return;
            }

            this.disabled = true;
            this.textContent = 'Đang xử lý...';

            try {
                const token = getJwtToken();
                console.log("[DEBUG] JWT token khi tạo booking:", token);

                const res = await fetch(bookingApiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stylistId: bookingSelection.stylistId,
                        serviceId: bookingSelection.serviceId,
                        startTime: bookingSelection.startTime.toISOString()
                    })
                });

                console.log("[DEBUG] Booking response status:", res.status);

                if (!res.ok) {
                    if (res.status === 401) throw new Error('Token không hợp lệ hoặc đã hết hạn. Vui lòng đăng nhập lại.');
                    const text = await res.text();
                    throw new Error(text || 'Đặt lịch thất bại.');
                }

                       alert('Đặt lịch thành công!');
        window.location.href = '/ServicesCustomer/MyBookings';


            } catch (e) {
                console.error('[ERROR] Booking:', e);
                err.textContent = e.message;
                this.disabled = false;
                this.textContent = 'Xác nhận Đặt lịch';
            }
        });

        function activateStep(step) { step.classList.remove('opacity-50'); }

        document.addEventListener('DOMContentLoaded', loadServiceDetails);
    </script>
}

}
