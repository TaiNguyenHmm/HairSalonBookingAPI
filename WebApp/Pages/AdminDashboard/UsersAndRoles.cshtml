@page
@{
    ViewData["Title"] = "Quản lý Users & Roles - Hair Salon Admin";
    Layout = "_AdminLayout";
}

<div class="flex justify-between items-center mb-6">
    <button id="add-user-btn"
            class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
             xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Thêm User
    </button>
</div>

<!-- Filters -->
<div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
    <form id="user-filter-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div>
            <label for="search-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tìm (Username/Email)</label>
            <input type="text" id="search-filter" placeholder="e.g., 'customer1'"
                   class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
            <label for="role-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vai trò</label>
            <select id="role-filter"
                    class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">Tất cả Vai trò</option>
                <option value="Admin">Admin</option>
                <option value="Stylist">Stylist</option>
                <option value="Customer">Customer</option>
            </select>
        </div>
        <div>
            <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700">
                Lọc
            </button>
        </div>
    </form>
</div>

<!-- Users Table -->

<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full table-auto">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>

                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Username</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Số điện thoại</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Vai trò</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ngày tạo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Cập nhật lần cuối</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Hành động</th>
                </tr>
            </thead>
            <tbody id="user-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Fill bằng JS fetch API -->
            </tbody>
        </table>
    </div>
</div>




<!-- Modal Add/Edit User -->
<div id="user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-lg w-full">
        <h3 id="modal-title" class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Thêm User mới</h3>

        <form id="user-form" class="space-y-4">
            <input type="hidden" id="user-id">

            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tên đăng nhập</label>
                <input type="text" id="username" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" required >
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                    <input type="email" id="email" name="email" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Số điện thoại</label>
                    <input type="tel" id="phone" name="phone" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                </div>
            </div>

            <!-- Password chỉ hiển thị khi Thêm user -->
            <div id="password-section">
                <label for="password">Mật khẩu</label>
                <input type="password" id="password" name="password" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
            </div>

            <div>
                <label for="role" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vai trò</label>
                <select id="role" name="role" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                    <option value="Customer">Customer</option>
                    <option value="Stylist">Stylist</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" id="close-user-modal-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">Hủy</button>
                <button type="submit" id="save-user-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Lưu</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const apiUrl = "https://localhost:7144/api/User";
            const token = localStorage.getItem("jwtToken");

            const userTableBody = document.getElementById("user-table-body");
            const userModal = document.getElementById("user-modal");
            const userForm = document.getElementById("user-form");
            const passwordSection = document.getElementById("password-section");
            const passwordInput = document.getElementById("password");
            const searchFilter = document.getElementById("search-filter");
            const roleFilter = document.getElementById("role-filter");
            const filterForm = document.getElementById("user-filter-form");

            // Load Users
            async function loadUsers() {
                const res = await fetch(apiUrl, { headers: { "Authorization": `Bearer ${token}` } });
                const users = await res.json();

                const search = searchFilter.value.toLowerCase();
                const role = roleFilter.value;
                const filtered = users.filter(u =>
                    (!search || u.username.toLowerCase().includes(search) || (u.email && u.email.toLowerCase().includes(search))) &&
                    (!role || u.role === role)
                );

                userTableBody.innerHTML = filtered.map(u => `
                    <tr>
                        <td>${u.username}</td>
                        <td>${u.email ?? '-'}</td>
                        <td>${u.phone ?? '-'}</td>
                        <td>${u.role}</td>
                        <td>${new Date(u.createdAt).toLocaleString()}</td>
                        <td>${u.updatedAt ? new Date(u.updatedAt).toLocaleString() : '-'}</td>
                        <td>
                            <button class="btn-edit text-indigo-600 hover:text-indigo-900" data-id="${u.id}">Sửa</button>
                        </td>
                    </tr>
                `).join("");
            }

            loadUsers();

            // Thêm user
            document.getElementById('add-user-btn').onclick = () => {
                userForm.reset();
                document.getElementById('modal-title').textContent = 'Thêm User mới';
                document.getElementById('user-id').value = '';

                passwordInput.required = true;
                passwordSection.style.display = 'block';

                userModal.classList.remove('hidden');
            };

            // Đóng modal
            document.getElementById('close-user-modal-btn').onclick = () => userModal.classList.add('hidden');

            // Sửa user
            userTableBody.addEventListener('click', async (e) => {
                if (!e.target.classList.contains('btn-edit')) return;

                const id = e.target.dataset.id;
                const res = await fetch(`${apiUrl}/${id}`, { headers: { "Authorization": `Bearer ${token}` } });
                const u = await res.json();

                document.getElementById('modal-title').textContent = 'Sửa thông tin User';
                document.getElementById('user-id').value = u.id;
                document.getElementById('username').value = u.username;
                document.getElementById('email').value = u.email ?? '';
                document.getElementById('phone').value = u.phone ?? '';
                document.getElementById('role').value = u.role;

                passwordInput.required = false;
                passwordInput.value = '';
                passwordSection.style.display = 'none';

                userModal.classList.remove('hidden');
            });

            // Lưu (thêm/sửa)
            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('user-id').value;
                let userData;

                       if (!id) { // Thêm user
            userData = {
                username: document.getElementById('username').value,
                password: passwordInput.value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                role: document.getElementById('role').value
            };
        } else { // Sửa user
            userData = {
                username: document.getElementById('username').value, // Thêm username
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                role: document.getElementById('role').value
            };
            if (passwordInput.value) { // Chỉ gửi password nếu nhập
                userData.password = passwordInput.value;
            }
        }


                const method = id ? "PUT" : "POST";
                const url = id ? `${apiUrl}/${id}` : apiUrl;

                const res = await fetch(url, {
                    method,
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });

                if (res.ok) {
                    userModal.classList.add('hidden');
                    loadUsers();
                } else {
                    alert("Cập nhật thất bại!");
                }
            });

            // Filter form submit
            filterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loadUsers();
            });
        });
    </script>
}
