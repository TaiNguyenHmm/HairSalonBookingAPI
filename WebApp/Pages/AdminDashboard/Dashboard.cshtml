@page
@model DashboardModel
@{
    Layout = "/Pages/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Dashboard Overview";
}

<h2 class="text-xl font-semibold mb-4">Chào mừng Admin!</h2>

<!-- KPI Section -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Bookings hôm nay</p>
        <p id="bookingsToday" class="text-3xl font-bold text-gray-900 dark:text-white">0</p>
    </div>

    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Doanh thu hôm nay</p>
        <p id="revenueToday" class="text-3xl font-bold text-gray-900 dark:text-white">0 ₫</p>
    </div>

    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tỉ lệ No-show (tháng)</p>
        <p id="noShowRate" class="text-3xl font-bold text-gray-900 dark:text-white">—</p>
    </div>

    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Rating trung bình</p>
        <p id="avgRating" class="text-3xl font-bold text-gray-900 dark:text-white">0 / 5</p>
    </div>
</div>

<!-- Charts & To-do list -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Revenue Chart -->
    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Doanh thu theo Dịch vụ (tháng)</h2>
        <canvas id="revenueChart"></canvas>
    </div>

    <!-- To-do list -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Việc cần làm</h2>
        <ul class="space-y-4">
            <li class="flex items-start">
                <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <div>
                    <p class="font-medium text-gray-800 dark:text-gray-200">
                        Xác nhận <span id="pendingBookings" class="font-bold">0</span> bookings
                        <span class="text-sm text-gray-500 dark:text-gray-400">(Pending)</span>
                    </p>
                    <a href="/AdminDashboard/ManageBookings" class="text-sm text-indigo-600 hover:underline">Xem chi tiết</a>
                </div>
            </li>

            <li class="flex items-start">
                <div class="w-2 h-2 bg-green-500 rounded-full mt-2 mr-3 flex-shrink-0"></div>
                <div>
                    <p class="font-medium text-gray-800 dark:text-gray-200">
                        Có <span id="reviewsToday" class="font-bold">0</span> đánh giá mới hôm nay
                    </p>
                    <a href="/AdminDashboard/ReviewsModeration" class="text-sm text-indigo-600 hover:underline">Xem chi tiết</a>
                </div>
            </li>
        </ul>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const dashboardApi = "https://localhost:7144/api/Dashboard/overview";
        const token = localStorage.getItem("jwtToken");

        document.addEventListener("DOMContentLoaded", loadDashboardData);

        async function loadDashboardData() {
            if (!token) {
                console.error("❌ Chưa có token, vui lòng đăng nhập lại!");
                return;
            }

            try {
                const res = await fetch(dashboardApi, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });

                if (!res.ok) {
                    console.error("❌ Lỗi API:", await res.text());
                    return;
                }

                const data = await res.json();

                // Gán dữ liệu lên giao diện
                document.getElementById("bookingsToday").textContent = data.bookingsToday ?? 0;
                document.getElementById("revenueToday").textContent =
                    (data.revenueToday ?? 0).toLocaleString("vi-VN") + " ₫";
                document.getElementById("avgRating").textContent =
                    (data.avgRating ?? 0).toFixed(1) + " / 5";
                document.getElementById("pendingBookings").textContent = data.pendingBookings ?? 0;
                document.getElementById("reviewsToday").textContent = data.reviewsToday ?? 0;


                // Tạo biểu đồ doanh thu theo dịch vụ
                if (data.serviceRevenue && data.serviceRevenue.length > 0) {
                    const labels = data.serviceRevenue.map(s => s.name);
                    const totals = data.serviceRevenue.map(s => s.total);

                    const ctx = document.getElementById("revenueChart");
                    new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: labels,
                            datasets: [{
                                label: "Doanh thu (VNĐ)",
                                data: totals,
                                backgroundColor: "rgba(79, 70, 229, 0.8)",
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }

            } catch (err) {
                console.error("⚠️ Lỗi khi tải Dashboard:", err);
            }
        }
    </script>
}
