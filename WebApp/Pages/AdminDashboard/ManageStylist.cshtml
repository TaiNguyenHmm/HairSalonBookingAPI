@page
@{
    Layout = "/Pages/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Quản lý Stylist";
}

<!-- Nút thêm -->
<div class="flex justify-between items-center mb-6">
    <button id="add-stylist-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Thêm Stylist
    </button>
</div>

<!-- Bảng Stylist -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
    <table class="w-full table-auto">
        <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Họ Tên</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Điện thoại</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Giới thiệu (Bio)</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="stylist-table-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
    </table>
</div>

<!-- Modal: Thêm/Sửa Stylist -->
<div id="stylist-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-lg w-full">
        <h3 id="stylist-modal-title" class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Thêm Stylist mới</h3>
        <form id="stylist-form" class="space-y-4">
            <input type="hidden" id="stylist-id">
            <input type="hidden" id="user-id">
            <div>
                <label for="fullname" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Họ Tên</label>
                <input type="text" id="fullname" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700" required>
            </div>
            <div>
                <label for="bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Giới thiệu</label>
                <textarea id="bio" rows="3" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="username" class="block text-sm">Username</label>
                    <input type="text" id="username" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700" required>
                </div>
                <div>
                    <label for="password" class="block text-sm">Mật khẩu</label>
                    <input type="password" id="password" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="email" class="block text-sm">Email</label>
                    <input type="email" id="email" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700" required>
                </div>
                <div>
                    <label for="phone" class="block text-sm">Điện thoại</label>
                    <input type="tel" id="phone" class="mt-1 w-full p-2 border rounded-md dark:bg-gray-700">
                </div>
            </div>
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" id="close-stylist-modal-btn" class="bg-gray-200 px-4 py-2 rounded">Hủy</button>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Lưu</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Quản lý giờ làm việc -->
<div id="hours-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-2xl w-full">
        <h3 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Quản lý giờ làm việc</h3>
        <p class="text-lg font-semibold mb-4 dark:text-gray-300">
            Stylist: <span id="hours-stylist-name"></span>
        </p>
        <form id="hours-form" class="space-y-4">
            <input type="hidden" id="hours-stylist-id">
            <div id="hours-container"></div>
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" id="close-hours-modal-btn" class="bg-gray-200 px-4 py-2 rounded">Đóng</button>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Lưu giờ làm việc</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiUrl = "https://localhost:7144/api/Stylist";
            const token = localStorage.getItem("jwtToken");

            const stylistTableBody = document.getElementById('stylist-table-body');
            const stylistModal = document.getElementById('stylist-modal');
            const addStylistBtn = document.getElementById('add-stylist-btn');
            const closeStylistModalBtn = document.getElementById('close-stylist-modal-btn');
            const stylistForm = document.getElementById('stylist-form');

            const hoursModal = document.getElementById('hours-modal');
            const closeHoursModalBtn = document.getElementById('close-hours-modal-btn');
            const hoursForm = document.getElementById('hours-form');
            const hoursStylistName = document.getElementById('hours-stylist-name');
            const hoursStylistId = document.getElementById('hours-stylist-id');

            // ================= Load Stylist =================
            async function loadStylists() {
                const res = await fetch(apiUrl, { headers: { Authorization: "Bearer " + token } });
                if (!res.ok) { alert("Lỗi tải stylist"); return; }

                const stylists = await res.json();
                stylistTableBody.innerHTML = '';
                stylists.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.dataset.stylistId = s.id;
                    tr.innerHTML = `
                        <td class="px-6 py-4">${s.fullName}</td>
                        <td class="px-6 py-4">${s.email || ''}</td>
                        <td class="px-6 py-4">${s.phone || ''}</td>
                        <td class="px-6 py-4">${s.bio || ''}</td>
                        <td><button class="text-yellow-600 hover:text-yellow-900" title="Giờ làm việc">Giờ làm việc</button></td>
                    `;
                    stylistTableBody.appendChild(tr);
                });
            }

            loadStylists();

            // ================= Add Stylist =================
            addStylistBtn.addEventListener('click', () => {
                stylistForm.reset();
                stylistModal.classList.remove('hidden');
            });

            closeStylistModalBtn.addEventListener('click', () => stylistModal.classList.add('hidden'));

            stylistForm.addEventListener('submit', async e => {
                e.preventDefault();
                const data = {
                    fullName: fullname.value,
                    username: username.value,
                    password: password.value,
                    email: email.value,
                    phone: phone.value,
                    bio: bio.value
                };

                const res = await fetch(apiUrl + '/create-with-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify(data)
                });
                if (!res.ok) return alert("Lỗi khi lưu stylist");
                stylistModal.classList.add('hidden');
                loadStylists();
            });

            // ================= Working Hours =================
            stylistTableBody.addEventListener('click', async e => {
                if (!e.target.matches('button[title="Giờ làm việc"]')) return;

                const row = e.target.closest('tr');
                const stylistId = row.dataset.stylistId;
                const name = row.children[0].textContent;

                hoursStylistName.textContent = name;
                hoursStylistId.value = stylistId;

                const container = document.getElementById('hours-container');
                container.innerHTML = '';

                const res = await fetch(`${apiUrl}/${stylistId}/working-hours`, { headers: { Authorization: 'Bearer ' + token } });
                const hours = res.ok ? await res.json() : [];

                [1,2,3,4,5,6,7].forEach(d => {
                    const h = hours.find(x => x.dayOfWeek === d) || {};
                    container.innerHTML += `
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <label class="flex items-center gap-2">
                                <span>Ngày ${d}</span>
                                <input type="time" class="start-time border p-1 rounded" value="${h.startTime || ''}">
                                <input type="time" class="end-time border p-1 rounded" value="${h.endTime || ''}">
                            </label>
                        </div>`;
                });

                hoursModal.classList.remove('hidden');
            });

            closeHoursModalBtn.addEventListener('click', () => hoursModal.classList.add('hidden'));

            hoursForm.addEventListener('submit', async e => {
                e.preventDefault();

                const stylistId = hoursStylistId.value;
                const rows = document.querySelectorAll('#hours-container div');
                const data = Array.from(rows).map((r, i) => ({
                    dayOfWeek: i + 1,
                    startTime: r.querySelector('.start-time').value,
                    endTime: r.querySelector('.end-time').value
                }));

                const res = await fetch(`${apiUrl}/${stylistId}/working-hours`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('Lưu giờ làm việc thành công');
                    hoursModal.classList.add('hidden');
                } else {
                    const err = await res.text();
                    console.error(err);
                    alert('Lỗi khi lưu giờ làm việc');
                }
            });
        });
    </script>
}
